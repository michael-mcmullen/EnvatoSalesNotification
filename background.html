<html>
	<head>
		<!--
		Copyright 2011 Tutelage Systems
		http://www.tutelagesystems.com
		-->
		<script>
			// Variables
			var envato_username = localStorage["envato_username"];
			var envato_key 			= localStorage["envato_key"]
			var envato_polling 	= localStorage["envato_polling"];
			var envato_home 		= localStorage["envato_home"];
			var envato_sale			= localStorage["envato_sale"];
			var count_sales			= 0;
			var seconds					= 60000;
			var interval_id;
			var	send_notification	= true; // Send a Notification?
			
			// Did we click our button?
			chrome.browserAction.onClicked.addListener(function(tab) {
				// clear the sales count
				count_sales = 0;
				chrome.browserAction.setBadgeText({text: ''});
				chrome.browserAction.setTitle({title: 'no new sales'});
				
				// Set Notification Display to True (so we can do it)
				send_notification = true;
					
				// Check for home page
				if(!envato_home){ envato_home = "options.html" }
				// Open new tab
				chrome.tabs.create({url: envato_home + 'user/' + envato_username + '/statement'});
			});
			
			function polling() {
				console.log('Polling Envato');
				
				// Refresh Data
				envato_username = localStorage["envato_username"];
				envato_key 			= localStorage["envato_key"]
				envato_polling 	= localStorage["envato_polling"];
				envato_home 		= localStorage["envato_home"];
				envato_sale			= localStorage["envato_sale"];
				
				// Check Polling
				if(!envato_polling) {
					envato_polling = 5 * seconds;
				} else {
					envato_polling = envato_polling * seconds;
				}
				
				// Set Interval
				clearInterval(interval_id);
				interval_id = setInterval(polling, envato_polling)
				
				if(!envato_username || !envato_key || !envato_polling) {
					chrome.browserAction.setTitle({title: 'check options'});
					chrome.browserAction.setBadgeText({text: '?'});
				} else {
					chrome.browserAction.setBadgeText({text: '' + (count_sales ? count_sales : '')});
					chrome.browserAction.setTitle({title: 'no new sales'});
				}
				
				// Check our Last Sale
				if(!envato_sale) {
					console.log('Setting Date');
					storeSaleDate("June 02, 1983 12:00:00");
				}
				
				req = new XMLHttpRequest();
				req.open('GET', 'http://marketplace.envato.com/api/v2/' + envato_username + '/' + envato_key + '/recent-sales.json');
				req.onload = processRecentSales;
				req.send();
			}
			
			function processRecentSales() {
				var res = JSON.parse(req.responseText);
				
				if("error" in res) {
					console.log(new Date());
					console.log(res.error);
					chrome.browserAction.setTitle({title: 'api error'});
					chrome.browserAction.setBadgeText({text: 'x'});
					
					// Do not poll for 1 hour and 5 minutes
					clearInterval(interval_id);
					interval_id = setInterval(polling, 3900000)
					
					return;
				}
				
				var recent = res["recent-sales"];
				
				var notification_bodies = [];
				
				for(var i = recent.length -1; i > 0; i--) {
					item_date = Date.parse(recent[i].sold_at);
					
					if(item_date > envato_sale) {
						storeSaleDate(recent[i].sold_at);
						count_sales ++;
						notification_bodies.push(recent[i].item + ' ($' + recent[i].amount + ')');
					}
				}
				
				if(count_sales > 0) {
					chrome.browserAction.setBadgeText({text: '' + count_sales});
					chrome.browserAction.setTitle({title: '' + count_sales + ' new sales'});
					
					if(send_notification)
					{
						// Only Send 1 Notification
						send_notification = false;
						
						var notification = webkitNotifications.createNotification(
					  	'images/Money_48.png',  // icon url - can be relative
					  	'New Sales',  // notification title
					  	notification_bodies.join('; ')
						);
						
						// Then show the notification.
						notification.show();
					}
				} else {
					chrome.browserAction.setBadgeText({text: ''});
					chrome.browserAction.setTitle({title: 'no new sales'});
				}
			}
			
			function storeSaleDate(new_date) {
				envato_sale 								= Date.parse(new_date)
				localStorage["envato_sale"] = envato_sale;
			}
			
			function isArray(obj) {
				if (obj.constructor.toString().indexOf("Array") == -1)
			  	return false;
			  else
			  	return true;
			}
			
			polling();
		</script>
	</head>
</html>